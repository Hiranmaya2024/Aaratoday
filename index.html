<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aaradhya Today</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{font-family:Poppins;margin:0;background:#f4f6f9}
.header{background:#0d6efd;color:#fff;padding:14px;font-weight:600}
.routeBox{background:#fff;margin:10px;padding:14px;border-radius:14px;
display:grid;grid-template-columns:1fr 1fr;gap:14px;
box-shadow:0 2px 10px rgba(0,0,0,0.08)}
.leftBox{font-size:14px;line-height:1.8}
.partyList{max-height:170px;overflow:auto;font-size:13px}
.grid{padding:10px;display:grid;gap:12px}
.customer{background:#fff;padding:14px;border-radius:12px;
box-shadow:0 2px 6px rgba(0,0,0,0.08)}
.profileWrapper{background:#f4f6f9;min-height:100vh}
.profileHeader{background:linear-gradient(135deg,#2b6cb0,#1e4e8c);
color:#fff;padding:18px;font-size:18px;font-weight:600;display:flex;gap:10px}
.backBtn{background:#ffffff33;border:none;color:#fff;padding:6px 12px;border-radius:8px}
.profileCard{background:#fff;margin:15px;padding:18px;border-radius:18px;
box-shadow:0 6px 16px rgba(0,0,0,0.15)}
.info{margin:8px 0}
.actionRow{display:flex;gap:10px;margin-top:20px}
.actionRow button{flex:1;padding:14px;border:none;border-radius:10px;color:#fff;font-weight:600}
.call{background:#34a853}.wa{background:#25D366}.nav{background:#2b6cb0}
.tour{background:#ff9800;margin-top:10px;width:100%}
input,select{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
</style>
</head>

<body>

<div id="mainScreen">
<div class="header">Aaradhya Today</div>
<div id="routeBox" class="routeBox"></div>
<div id="customerGrid" class="grid"></div>
</div>

<div id="profileScreen" style="display:none"></div>

<script>

const HQ_LAT=20.9964
const HQ_LNG=83.0526
const todayKey=new Date().toDateString()

let visitedParties=JSON.parse(localStorage.getItem("visitedParties")||"[]")
let collections=JSON.parse(localStorage.getItem("collections")||"[]")

if(localStorage.getItem("tourDate")!==todayKey){
localStorage.setItem("tourDate",todayKey)
localStorage.removeItem("visitedParties")
localStorage.removeItem("tourIndex")
visitedParties=[]
collections=[]
}

const csvUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

let customers=[],todayRoute=[],selected={}

function parseCSV(text){
const rows=[];let row=[],value="",insideQuotes=false
for(let char of text){
if(char=='"'){insideQuotes=!insideQuotes;continue}
if(char==","&&!insideQuotes){row.push(value);value="";continue}
if((char=="\n"||char=="\r")&&!insideQuotes){
if(value||row.length){row.push(value);rows.push(row)}
row=[];value="";continue}
value+=char}
return rows
}

fetch(csvUrl)
.then(res=>res.text())
.then(text=>{
localStorage.setItem("customerCSV",text)
loadData(text)
})
.catch(()=>{
let offlineData=localStorage.getItem("customerCSV")
if(offlineData){loadData(offlineData)}
})

function loadData(text){
let rows=parseCSV(text).slice(1).filter(r=>r[0])

customers=rows.map(r=>({
name:r[0],area:r[1],business:r[5],due:r[6],
phone:r[13],lat:r[14],lng:r[15],
lastSale:r[17],lastCollection:r[18],route:r[19]
}))

todayRoute=customers
renderAll()
}

function getDist(a,b,c,d){
const R=6371
const dLat=(c-a)*Math.PI/180
const dLng=(d-b)*Math.PI/180
const x=Math.sin(dLat/2)**2+
Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
Math.sin(dLng/2)**2
return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x))
}

function calcRoute(){
let total=0,prevLat=HQ_LAT,prevLng=HQ_LNG
todayRoute.forEach(p=>{
if(p.lat){total+=getDist(prevLat,prevLng,p.lat,p.lng)
prevLat=p.lat;prevLng=p.lng}})
total+=getDist(prevLat,prevLng,HQ_LAT,HQ_LNG)
return total
}

function renderAll(){

let totalDist=calcRoute()
let time=(totalDist/25).toFixed(1)

let todayTotal=collections.reduce((sum,c)=>sum+Number(c.amount),0)

routeBox.innerHTML=`
<div class="leftBox">
âœ” Parties: ${todayRoute.length}<br>
âœ… Visited: ${visitedParties.length}<br>
ğŸ“ Remaining: ${todayRoute.length-visitedParties.length}<br>
ğŸ’° Collection: â‚¹ ${todayTotal}<br>
âœ” Round-trip: ${totalDist.toFixed(1)} km<br>
âœ” Travel time: ${time} hrs<br>
<button class="tour" onclick="startTour()">ğŸ§­ Start Tour</button>
</div>

<div class="partyList">
${todayRoute.map((c,i)=>`
<div onclick="openProfileByName('${c.name}')">
${i+1}. ${c.name}
</div>`).join("")}
</div>
`

customerGrid.innerHTML=""
customers.forEach(c=>{
customerGrid.innerHTML+=`
<div class="customer" onclick="openProfileByName('${c.name}')">
<b>${c.name}</b><br>${c.area} | â‚¹${c.due}
</div>`
})
}

function startTour(){
let lastIndex=localStorage.getItem("tourIndex")||0
let remaining=todayRoute.slice(lastIndex)
let route=remaining.map(c=>`${c.lat},${c.lng}`).join("/")
window.open(`https://www.google.com/maps/dir/${HQ_LAT},${HQ_LNG}/${route}/${HQ_LAT},${HQ_LNG}`)
}

function openProfileByName(name){

let index=todayRoute.findIndex(c=>c.name===name)
localStorage.setItem("tourIndex",index)

selected=customers.find(c=>c.name===name)

mainScreen.style.display="none"
profileScreen.style.display="block"

profileScreen.innerHTML=`
<div class="profileWrapper">
<div class="profileHeader">
<button class="backBtn" onclick="goBack()">â¬… Back</button>Customer Profile
</div>

<div class="profileCard">

<h2>${selected.name}</h2>

<div class="info"><b>Phone:</b> <a href="tel:${selected.phone}">${selected.phone}</a></div>
<div class="info"><b>Area:</b> ${selected.area}</div>
<div class="info"><b>Total Business:</b> â‚¹${selected.business}</div>
<div class="info"><b>Total Due:</b> â‚¹${selected.due}</div>

<div class="info">ğŸ“… Last Sale: ${selected.lastSale}</div>
<div class="info">ğŸ’° Last Payment: ${selected.lastCollection}</div>
<div class="info">ğŸ—º Route: ${selected.route}</div>

<h3>ğŸ’° Enter Collection</h3>
<input id="colAmt" type="number" placeholder="Amount">
<select id="payMode">
<option>Cash</option>
<option>UPI</option>
<option>Cheque</option>
<option>NEFT</option>
</select>
<input id="remark" placeholder="Remarks">

<button class="tour" onclick="saveCollection()">ğŸ’¾ Save Collection</button>
<button class="tour" onclick="markVisited()">âœ… Visit Done</button>

<div class="actionRow">
<button class="call" onclick="call()">ğŸ“</button>
<button class="wa" onclick="whatsapp()">WhatsApp</button>
<button class="nav" onclick="navigate()">ğŸ“</button>
</div>

</div></div>`
}

function saveCollection(){
let amt=document.getElementById("colAmt").value
let mode=document.getElementById("payMode").value
let remark=document.getElementById("remark").value

if(!amt){alert("Enter amount");return}

collections.push({party:selected.name,amount:amt,mode,remark,date:todayKey})
localStorage.setItem("collections",JSON.stringify(collections))

alert("Collection Saved")
renderAll()
}

function markVisited(){

if(!visitedParties.includes(selected.name)){
visitedParties.push(selected.name)
localStorage.setItem("visitedParties",JSON.stringify(visitedParties))
}

let currentIndex=todayRoute.findIndex(c=>c.name===selected.name)
localStorage.setItem("tourIndex",currentIndex+1)

goBack()

let next=todayRoute[currentIndex+1]
if(next){setTimeout(()=>openProfileByName(next.name),300)}
else{alert("ğŸ‰ Tour Completed")}
}

function goBack(){
profileScreen.style.display="none"
mainScreen.style.display="block"
}

function call(){window.location.href="tel:"+selected.phone}
function whatsapp(){window.open(`https://wa.me/91${selected.phone}`)}
function navigate(){window.open(`https://www.google.com/maps?q=${selected.lat},${selected.lng}`)}

if('serviceWorker' in navigator){
navigator.serviceWorker.register('service-worker.js')
}

</script>

</body>
</html>