<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aaradhya Today</title>

<style>
body{margin:0;font-family:system-ui;background:#eef2f7;}
.app{max-width:1400px;margin:auto;}

.routeCard{
background:#fff;margin:14px;padding:18px;border-radius:22px;
box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.mapPreview{
width:100%;
height:220px;
border-radius:14px;
margin-bottom:12px;
object-fit:cover;
}

.progressBox{
background:#f8f9fa;
padding:14px;
border-radius:14px;
margin-bottom:12px;
line-height:1.8;
font-size:15px;
}

.btn{
margin-top:10px;height:52px;border:none;border-radius:12px;
width:100%;font-size:16px;font-weight:600;
}

.previewBtn{background:#0d6efd;color:#fff;}
.startBtn{background:#ff9800;color:#000;}
.uploadBtn{background:#198754;color:#fff;}
</style>
</head>

<body>

<div class="app">
<div id="routeBox"></div>
</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

const HQ={lat:20.9964,lng:83.0526}

const tourPlan={
monday:["juria"],
tuesday:["ghess"],
wednesday:["gaisilate"],
thursday:["dava"],
friday:["padampur"],
saturday:["paikmal","mandosil"]
}

let customers=[]
const today=new Date().toLocaleDateString('en-US',{weekday:'long'}).toLowerCase()

function normalize(v){return (v||"").toLowerCase().trim()}

function parseCSV(text){
return text.split("\n").map(e=>e.split(","))
}

function getDistance(a,b){
const R=6371
const dLat=(b.lat-a.lat)*Math.PI/180
const dLng=(b.lng-a.lng)*Math.PI/180
const aa=Math.sin(dLat/2)**2+
Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*
Math.sin(dLng/2)**2
return R*2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa))
}

function getTodayParties(){
let areas=tourPlan[today]||[]
return customers.filter(c=>areas.includes(normalize(c.area)))
}

function calcDistance(route){
let total=0,current=HQ
route.forEach(p=>{total+=getDistance(current,p);current=p})
total+=getDistance(current,HQ)
return total
}

function saveScreenshot(input){
const file=input.files[0]
const reader=new FileReader()
reader.onload=function(){
localStorage.setItem("routeShot_"+today,reader.result)
render()
}
reader.readAsDataURL(file)
}

function removeShot(){
localStorage.removeItem("routeShot_"+today)
render()
}

function markVisited(name){
let key="visited_"+today
let arr=JSON.parse(localStorage.getItem(key)||"[]")
if(!arr.includes(name)){arr.push(name)}
localStorage.setItem(key,JSON.stringify(arr))
render()
}

function addCollection(){
let val=prompt("Enter collection amount")
if(!val) return
let key="collection_"+today
let total=Number(localStorage.getItem(key)||0)
total+=Number(val)
localStorage.setItem(key,total)
render()
}

function render(){

let todayRoute=getTodayParties()
let distance=calcDistance(todayRoute)

let visitedArr=JSON.parse(localStorage.getItem("visited_"+today)||"[]")
let visitedCount=visitedArr.length
let remaining=todayRoute.length-visitedCount

let collection=localStorage.getItem("collection_"+today)||0

let shot=localStorage.getItem("routeShot_"+today)

routeBox.innerHTML=`

<div class="routeCard">

<h3>ğŸ“… Todayâ€™s Route â€“ ${today.toUpperCase()}</h3>

${shot
? `<img src="${shot}" class="mapPreview">
<button class="btn uploadBtn" onclick="removeShot()">ğŸ”„ Replace Screenshot</button>`
: `<label class="btn uploadBtn">ğŸ“¥ Upload Route Screenshot
<input type="file" accept="image/*" style="display:none"
onchange="saveScreenshot(this)"></label>`
}

<div class="progressBox">
<b>ğŸ§­ Tour Progress</b><br>
âœ” Parties: ${todayRoute.length}<br>
ğŸ‘£ Visited: ${visitedCount}<br>
â³ Remaining: ${remaining}<br>
ğŸ“ KM: ${distance.toFixed(1)}<br>
â± Time: ${(distance/25).toFixed(1)} hrs<br>
ğŸ’° Collection: â‚¹${collection}
</div>

<button class="btn previewBtn" onclick="window.open('${buildGoogleMapsLink(todayRoute)}')">
ğŸ—º Preview Full Route
</button>

<button class="btn startBtn" onclick="window.open('${buildGoogleMapsLink(todayRoute)}')">
ğŸ§­ Start Tour
</button>

<hr>

${todayRoute.map(p=>`
<div>
${p.name}
<button onclick="markVisited('${p.name}')">âœ…</button>
</div>
`).join("")}

<button class="btn uploadBtn" onclick="addCollection()">ğŸ’° Add Collection</button>

</div>
`
}

function buildGoogleMapsLink(route){
let waypoints=route.map(p=>`${p.lat},${p.lng}`).join("/")
return `https://www.google.com/maps/dir/${HQ.lat},${HQ.lng}/${waypoints}/${HQ.lat},${HQ.lng}`
}

function loadData(text){
let rows=parseCSV(text)
rows.shift()
customers=rows.filter(r=>r[0]).map(r=>({
name:r[0],
area:r[1],
lat:parseFloat(r[14]),
lng:parseFloat(r[15])
}))
render()
}

fetch(CSV).then(r=>r.text()).then(loadData)

</script>

</body>
</html>