<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aaradhya Today</title>

<style>
body{font-family:Arial;margin:0;background:#f2f2f2}
.header{background:#0d6efd;color:#fff;padding:14px;font-weight:bold}
.box{background:#fff;margin:10px;padding:12px;border-radius:12px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:10px;padding:10px}
.card{background:#fff;padding:12px;border-radius:10px}
button{padding:10px;border:none;border-radius:8px;background:#0d6efd;color:#fff;margin-top:6px}
</style>
</head>

<body>

<div class="header">Aaradhya Today</div>
<div id="status" class="box"></div>
<div id="routeBox" class="box"></div>
<div id="grid" class="grid"></div>

<div id="profile" style="display:none"></div>

<script>

const HQ_LAT=20.9964
const HQ_LNG=83.0526

function getCSVUrl(){
return "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv&nocache="+Date.now()
}

function updateStatus(t){status.innerHTML=t}

function getDistance(lat,lng){
const R=6371
const dLat=(lat-HQ_LAT)*Math.PI/180
const dLng=(lng-HQ_LNG)*Math.PI/180
const a=Math.sin(dLat/2)**2+
Math.cos(HQ_LAT*Math.PI/180)*Math.cos(lat*Math.PI/180)*
Math.sin(dLng/2)**2
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))
}

function calcRouteDistance(list){

let total=0
let prevLat=HQ_LAT
let prevLng=HQ_LNG

list.forEach(p=>{
total+=getDistance(p.lat,p.lng)
prevLat=p.lat
prevLng=p.lng
})

total+=getDistance(HQ_LAT,HQ_LNG)

return total
}

function parseCSV(t){
return t.split("\n").map(e=>e.split(","))
}

function fetchData(){

updateStatus("üîÑ Syncing latest data...")

fetch(getCSVUrl())
.then(r=>r.text())
.then(text=>{

localStorage.setItem("csv",text)
updateStatus("üü¢ Live data "+new Date().toLocaleTimeString())

loadData(text)

})
.catch(()=>{

let data=localStorage.getItem("csv")
updateStatus("üü† Offline data")
loadData(data)

})

}

function loadData(text){

let rows=parseCSV(text).slice(1)

customers=rows.map(r=>({
name:r[0],
area:r[1],
status:r[2],
reason:r[3],
reactivate:r[4],
business:r[5],
due:parseFloat(r[6])||0,
phone:r[13],
lat:parseFloat(r[14]),
lng:parseFloat(r[15]),
lastSale:r[17],
lastCollection:r[18],
route:r[19]
}))

customers.sort((a,b)=>b.due-a.due)

render()

}

function render(){

let routeDistance=calcRouteDistance(customers)
let time=(routeDistance/25).toFixed(1)

routeBox.innerHTML=`
<b>Parties:</b> ${customers.length}<br>
<b>Round trip:</b> ${routeDistance.toFixed(1)} km<br>
<b>Travel time:</b> ${time} hr<br>
<button onclick="startTour()">Start Tour</button>
`

grid.innerHTML=""

customers.forEach(c=>{

let tag=c.status=="Blocked"?"üî¥ BLOCKED":c.due>0?"üí∞ COLLECT":""

grid.innerHTML+=`
<div class="card" onclick="openProfile('${c.name}')">
<b>${c.name}</b><br>
${c.area}<br>
‚Çπ${c.due}<br>
üìç ${getDistance(c.lat,c.lng).toFixed(1)} km<br>
${tag}
</div>`

})

}

function openProfile(name){

let c=customers.find(x=>x.name==name)

profile.style.display="block"
profile.innerHTML=`
<div class="box">

<button onclick="profile.style.display='none'">‚¨Ö Back</button>

<h3>${c.name}</h3>

üìû <a href="tel:${c.phone}">${c.phone}</a><br>
Area: ${c.area}<br>
Total Business: ${c.business}<br>
Total Due: ${c.due}<br>
Status: ${c.status}<br>
Reason: ${c.reason}<br>
Reactivate: ${c.reactivate}<br>

Last Sale: ${c.lastSale}<br>
Last Payment: ${c.lastCollection}<br>
Route: ${c.route}<br>

<button onclick="window.open('https://wa.me/91${c.phone}')">WhatsApp</button>
<button onclick="window.open('https://maps.google.com?q=${c.lat},${c.lng}')">Navigate</button>

</div>
`
}

function startTour(){

let waypoints=customers.slice(0,9).map(c=>`${c.lat},${c.lng}`).join("/")

window.open(`https://www.google.com/maps/dir/${HQ_LAT},${HQ_LNG}/${waypoints}/${HQ_LAT},${HQ_LNG}`)

}

fetchData()

</script>
</body>
</html>