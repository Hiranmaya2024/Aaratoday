<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aaradhya Today</title>

<style>
body{font-family:Arial;margin:0;background:#f2f2f2}
.header{background:#0d6efd;color:#fff;padding:14px;font-size:18px;font-weight:bold}

.statusBar{
background:#fff;margin:10px;padding:10px;border-radius:12px;
display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px
}

.routeGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.partyList{max-height:230px;overflow:auto;font-size:13px}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px;padding:10px}
.card{background:#fff;padding:12px;border-radius:12px}

.tagBlocked{color:red;font-weight:bold}
.tagCollect{color:green;font-weight:bold}
.newTag{background:#ff9800;color:#fff;font-size:10px;padding:2px 6px;border-radius:6px}

.profile{position:fixed;top:0;left:0;width:100%;height:100%;background:#f2f2f2;overflow:auto}
.profileCard{background:#fff;margin:10px;padding:16px;border-radius:14px}

.actionRow{display:flex;gap:10px;margin-top:10px}
.actionRow button{flex:1}

button{padding:10px;border:none;border-radius:8px;background:#0d6efd;color:#fff;margin-top:6px}
input{width:100%;padding:10px;margin-top:8px}
</style>
</head>

<body>

<div class="header">Aaradhya Today</div>

<div class="statusBar">
<div id="dataInfo"></div>
<div>
<button onclick="fetchData()">ğŸ”„</button>
<button onclick="clearCache()">ğŸ§¹</button>
</div>
</div>

<div id="routeBox" class="box"></div>
<div id="grid" class="grid"></div>
<div id="profile" class="profile" style="display:none"></div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

const HQ_LAT=20.9964
const HQ_LNG=83.0526

const tourPlan={
Monday:["Juria"],Tuesday:["Ghess"],Wednesday:["Gaisilate"],
Thursday:["Dava"],Friday:["Padampur"],Saturday:["Paikmal","Mandosil"]
}

const todayAreas=tourPlan[new Date().toLocaleDateString('en-US',{weekday:'long'})]||[]
const todayKey=new Date().toDateString()

let visited=JSON.parse(localStorage.getItem("visited")||"[]")
let collections=JSON.parse(localStorage.getItem("collections")||"[]")
let lastParties=JSON.parse(localStorage.getItem("lastParties")||"[]")

if(localStorage.getItem("tourDate")!=todayKey){
localStorage.setItem("tourDate",todayKey)
visited=[];collections=[]
}

function saveLocal(){
localStorage.setItem("visited",JSON.stringify(visited))
localStorage.setItem("collections",JSON.stringify(collections))
}

function updateNetwork(){
dataInfo.innerHTML=(navigator.onLine?"ğŸŸ¢ Online":"ğŸ”´ Offline")
}
window.addEventListener("online",updateNetwork)
window.addEventListener("offline",updateNetwork)

function getDistance(lat,lng){
const R=6371
const dLat=(lat-HQ_LAT)*Math.PI/180
const dLng=(lng-HQ_LNG)*Math.PI/180
const a=Math.sin(dLat/2)**2+
Math.cos(HQ_LAT*Math.PI/180)*Math.cos(lat*Math.PI/180)*
Math.sin(dLng/2)**2
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))
}

function parseCSV(text){
const rows=[];let row=[],value="",insideQuotes=false
for(let char of text){
if(char=='"'){insideQuotes=!insideQuotes;continue}
if(char==","&&!insideQuotes){row.push(value);value="";continue}
if((char=="\n"||char=="\r")&&!insideQuotes){
if(value||row.length){row.push(value);rows.push(row)}
row=[];value="";continue}
value+=char}
return rows
}

function fetchData(){

dataInfo.innerHTML="ğŸ”„ Fetching..."

fetch(CSV+"&nocache="+Date.now())
.then(r=>r.text())
.then(text=>{

localStorage.setItem("csv",text)

let time=new Date().toLocaleTimeString()
dataInfo.innerHTML+=` | ğŸ“… Sheet updated ${time}`

loadData(text)

})
.catch(()=>{
let data=localStorage.getItem("csv")
dataInfo.innerHTML+=" | ğŸŸ  Offline data"
loadData(data)
})
}

function loadData(text){

let rows=parseCSV(text).slice(1).filter(r=>r[0])

customers=rows.map(r=>({
name:r[0],
area:r[1],
status:r[2],
reason:r[3],
reactivate:r[4],
business:r[5],
due:parseFloat(r[6])||0,
phone:r[13],
lat:parseFloat(r[14]),
lng:parseFloat(r[15]),
lastSale:r[17],
lastCollection:r[18],
route:r[19],
isNew:!lastParties.includes(r[0])
}))

localStorage.setItem("lastParties",JSON.stringify(customers.map(c=>c.name)))

customers.sort((a,b)=>b.due-a.due)
todayRoute=customers.filter(c=>todayAreas.includes(c.area))

render()
}

function calcRouteDistance(list){
let total=0
list.forEach(p=>total+=getDistance(p.lat,p.lng))
return total*2
}

function render(){

let routeDistance=calcRouteDistance(todayRoute)
let time=(routeDistance/25).toFixed(1)
let todayCollection=collections.reduce((s,c)=>s+Number(c.amount),0)

routeBox.innerHTML=`

<div class="routeGrid">

<div>

âœ” Parties: ${todayRoute.length}<br>
ğŸ‘£ Visited: ${visited.length}<br>
ğŸ“ Remaining: ${todayRoute.length-visited.length}<br>
ğŸ’° Collection: â‚¹${todayCollection}<br>
ğŸ“ ${routeDistance.toFixed(1)} km<br>
â± ${time} hr<br>

<button onclick="startTour()">Start Tour</button>

</div>

<div class="partyList">

${todayRoute.map(c=>`
<div onclick="openProfile('${c.name}')">
<b>${c.name}</b>
${c.isNew?'<span class="newTag">NEW</span>':''}<br>
ğŸ“ ${getDistance(c.lat,c.lng).toFixed(1)} km
</div><br>
`).join("")}

</div>

</div>
`

grid.innerHTML=""

customers.forEach(c=>{

let tag=c.status=="Blocked"
?`<div class="tagBlocked">BLOCKED</div>`
:c.due>0
?`<div class="tagCollect">COLLECT</div>`:""

grid.innerHTML+=`
<div class="card" onclick="openProfile('${c.name}')">
<b>${c.name}</b>
${c.isNew?'<span class="newTag">NEW</span>':''}<br>
${c.area}<br>
â‚¹${c.due}<br>
ğŸ“ ${getDistance(c.lat,c.lng).toFixed(1)} km
${tag}
</div>`
})
}

function openProfile(name){

let c=customers.find(x=>x.name==name)

profile.style.display="block"

profile.innerHTML=`
<div class="profileCard">

<button onclick="profile.style.display='none'">â¬… Back</button>

<h2>${c.name}</h2>

ğŸ“ <a href="tel:${c.phone}">${c.phone}</a><br>
Area: ${c.area}<br>
Total Business: ${c.business}<br>
Total Due: ${c.due}<br>
Status: ${c.status}<br>
Reason: ${c.reason}<br>
Reactivate: ${c.reactivate}<br><br>

ğŸ“… Last Sale: ${c.lastSale}<br>
ğŸ’° Last Payment: ${c.lastCollection}<br>
ğŸ—º Route: ${c.route}<br>

<input id="amt" placeholder="Enter collection">

<button onclick="saveCollection('${c.name}')">Save Collection</button>
<button onclick="markVisited('${c.name}')">Visit Done</button>

<div class="actionRow">
<button onclick="window.open('tel:${c.phone}')">Call</button>
<button onclick="window.open('https://wa.me/91${c.phone}')">WhatsApp</button>
<button onclick="window.open('https://maps.google.com?q=${c.lat},${c.lng}')">Navigate</button>
</div>

</div>
`
}

function saveCollection(name){
let amt=document.getElementById("amt").value
collections.push({party:name,amount:amt})
saveLocal()
render()
}

function markVisited(name){
if(!visited.includes(name)){visited.push(name);saveLocal();render()}
profile.style.display="none"
}

function startTour(){
let waypoints=todayRoute.slice(0,9).map(c=>`${c.lat},${c.lng}`).join("/")
window.open(`https://www.google.com/maps/dir/${HQ_LAT},${HQ_LNG}/${waypoints}/${HQ_LAT},${HQ_LNG}`)
}

function clearCache(){
if(!confirm("Clear cache?"))return
localStorage.clear()
location.reload()
}

updateNetwork()
fetchData()

</script>
</body>
</html>