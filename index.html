<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aaradhya Today</title>

<style>
body{font-family:Arial;margin:0;background:#f2f2f2}
.header{background:#0d6efd;color:#fff;padding:14px;font-size:18px;font-weight:bold}
.statusBar{background:#fff;margin:10px;padding:10px;border-radius:12px;display:flex;justify-content:space-between;flex-wrap:wrap}

.routeGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.partyList{max-height:220px;overflow:auto;font-size:13px}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:10px;padding:10px}
.card{background:#fff;padding:12px;border-radius:12px}

.profile{position:fixed;top:0;left:0;width:100%;height:100%;background:#f2f2f2;overflow:auto;z-index:10}
.profileCard{background:#fff;margin:10px;padding:16px;border-radius:14px}

.actionRow{display:flex;gap:10px;margin-top:10px}
.actionRow button{flex:1}

input{width:100%;padding:10px;margin-top:8px}

button{padding:10px;border:none;border-radius:8px;background:#0d6efd;color:#fff;margin-top:8px}
</style>
</head>

<body>

<div class="header">Aaradhya Today</div>

<div class="statusBar">
<div id="dataInfo"></div>
<div>
<button onclick="reloadData()">üîÑ</button>
<button onclick="clearCache()">üßπ</button>
</div>
</div>

<div id="routeBox" class="box"></div>
<div id="grid" class="grid"></div>
<div id="profile" class="profile" style="display:none"></div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

const todayKey=new Date().toDateString()

let visited=JSON.parse(localStorage.getItem("visited")||"[]")
let collections=JSON.parse(localStorage.getItem("collections")||"[]")

if(localStorage.getItem("tourDate")!=todayKey){
localStorage.setItem("tourDate",todayKey)
visited=[]
collections=[]
}

function saveLocal(){
localStorage.setItem("visited",JSON.stringify(visited))
localStorage.setItem("collections",JSON.stringify(collections))
}

function fetchData(){
fetch(CSV+"&nocache="+Date.now())
.then(r=>r.text())
.then(text=>{
dataInfo.innerHTML="üü¢ Live "+new Date().toLocaleTimeString()
loadData(text)
})
}

function parseCSV(text){
return text.split("\n").map(e=>e.split(","))
}

function loadData(text){

let rows=parseCSV(text).slice(1)

customers=rows.map(r=>({
name:r[0],
area:r[1],
due:parseFloat(r[6])||0,
phone:r[13],
lat:r[14],
lng:r[15]
}))

render()
}

function render(){

let todayCollection=collections.reduce((s,c)=>s+Number(c.amount),0)

routeBox.innerHTML=`
‚úî Parties: ${customers.length}<br>
üë£ Visited: ${visited.length}<br>
üìç Remaining: ${customers.length-visited.length}<br>
üí∞ Collection: ‚Çπ${todayCollection}
`

grid.innerHTML=""

customers.forEach(c=>{
grid.innerHTML+=`
<div class="card" onclick="openProfile('${c.name}')">
<b>${c.name}</b><br>
‚Çπ${c.due}
</div>`
})
}

function openProfile(name){

let c=customers.find(x=>x.name==name)

profile.style.display="block"

profile.innerHTML=`
<div class="profileCard">

<button onclick="profile.style.display='none'">‚¨Ö Back</button>

<h3>${c.name}</h3>

<input id="amt" placeholder="Enter collection amount">

<button onclick="saveCollection('${c.name}')">Save Collection</button>

<button onclick="markVisited('${c.name}')">Visit Done</button>

<div class="actionRow">
<button onclick="window.open('tel:${c.phone}')">Call</button>
<button onclick="window.open('https://wa.me/91${c.phone}')">WhatsApp</button>
<button onclick="window.open('https://maps.google.com?q=${c.lat},${c.lng}')">Navigate</button>
</div>

</div>
`
}

function saveCollection(name){
let amt=document.getElementById("amt").value
collections.push({party:name,amount:amt})
saveLocal()
render()
}

function markVisited(name){
if(!visited.includes(name)){
visited.push(name)
saveLocal()
render()
}
profile.style.display="none"
}

fetchData()

</script>
</body>
</html>