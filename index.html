<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aaradhya Today</title>

<style>
body{margin:0;font-family:system-ui;background:#eef2f7;}
.app{max-width:1400px;margin:auto;}

.routeCard{
background:#fff;margin:14px;padding:18px;border-radius:22px;
box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.routeGrid{display:grid;gap:18px;}
@media(min-width:768px){
.routeGrid{grid-template-columns:1.1fr 1fr;}
}

.mapPreview{
width:100%;
height:220px;
border-radius:14px;
margin-bottom:12px;
border:0;
}

.startBtn{
margin-top:12px;height:50px;border:none;border-radius:12px;
width:100%;font-size:16px;font-weight:600;
background:#ff9800;color:#000;
}

.previewBtn{
margin-top:10px;height:45px;border:none;border-radius:12px;
width:100%;font-size:15px;font-weight:600;
background:#0d6efd;color:#fff;
}

.partyList{max-height:340px;overflow:auto;}
.partyName{font-weight:600;}
.partyDistance{color:#555;margin-left:22px;font-size:14px;}
</style>
</head>

<body>

<div class="app">
<div id="routeBox"></div>
</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

const HQ={lat:20.9964,lng:83.0526}

const tourPlan={
monday:["juria"],
tuesday:["ghess"],
wednesday:["gaisilate"],
thursday:["dava"],
friday:["padampur"],
saturday:["paikmal","mandosil"]
}

let customers=[]
const today=new Date().toLocaleDateString('en-US',{weekday:'long'}).toLowerCase()

function normalize(v){return (v||"").toLowerCase().trim()}

function parseCSV(text){
const rows=[];let row=[],value="",inside=false
for(let char of text){
if(char=='"'){inside=!inside;continue}
if(char==","&&!inside){row.push(value);value="";continue}
if((char=="\n"||char=="\r")&&!inside){
if(value||row.length){row.push(value);rows.push(row)}
row=[];value="";continue}
value+=char
}
return rows
}

function getDistance(a,b){
const R=6371
const dLat=(b.lat-a.lat)*Math.PI/180
const dLng=(b.lng-a.lng)*Math.PI/180
const aa=Math.sin(dLat/2)**2+
Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*
Math.sin(dLng/2)**2
return R*2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa))
}

function getTodayParties(){
let areas=tourPlan[today]||[]
return customers.filter(c=>areas.includes(normalize(c.area)))
}

function calcDistance(route){
let total=0,current=HQ
route.forEach(p=>{total+=getDistance(current,p);current=p})
total+=getDistance(current,HQ)
return total
}

function buildGoogleMapsLink(route){

let waypoints=route
.slice(0,9)
.map(p=>`${p.lat},${p.lng}`)
.join("/")

return `https://www.google.com/maps/dir/${HQ.lat},${HQ.lng}/${waypoints}/${HQ.lat},${HQ.lng}`
}

function render(){

let todayRoute=getTodayParties()
todayRoute.sort((a,b)=>getDistance(HQ,a)-getDistance(HQ,b))

let distance=calcDistance(todayRoute)
let previewMap=todayRoute[0]
? `https://maps.google.com/maps?q=${todayRoute[0].lat},${todayRoute[0].lng}&z=11&output=embed`
: ""

routeBox.innerHTML=`

<div class="routeCard">

<div class="routeGrid">

<div>

<h3>üìÖ Today‚Äôs Route ‚Äì ${today.toUpperCase()}</h3>

<iframe class="mapPreview" src="${previewMap}"></iframe>

‚úî Parties: ${todayRoute.length}<br>
‚úî Round-trip: ${distance.toFixed(1)} km<br>
‚úî Travel time: ${(distance/25).toFixed(1)} hrs

<button class="previewBtn" onclick="window.open('${buildGoogleMapsLink(todayRoute)}')">
üó∫ Preview Full Route
</button>

<button class="startBtn" onclick="window.open('${buildGoogleMapsLink(todayRoute)}')">
üß≠ Start Tour
</button>

</div>

<div class="partyList">

${todayRoute.map((c,i)=>`
<div>
<div class="partyName">${i+1}. ${c.name}</div>
<div class="partyDistance">üìç ${getDistance(HQ,c).toFixed(1)} km</div>
</div>
<br>
`).join("")}

</div>

</div>

</div>
`
}

function loadData(text){
let rows=parseCSV(text)
rows.shift()

customers=rows
.filter(r=>r[0])
.map(r=>({
name:r[0],
area:r[1],
lat:parseFloat(r[14]),
lng:parseFloat(r[15])
}))

render()
}

fetch(CSV).then(r=>r.text()).then(loadData)

</script>

</body>
</html>