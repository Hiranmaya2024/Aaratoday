<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aaradhya Today</title>

<style>
body{font-family:Arial;margin:0;background:#f2f2f2}
.header{background:#0d6efd;color:#fff;padding:14px;font-size:18px;font-weight:bold}

.statusBar{
background:#fff;
padding:10px;
display:flex;
justify-content:space-between;
align-items:center;
flex-wrap:wrap;
gap:8px;
margin:10px;
border-radius:12px
}

.statusText{font-size:13px}

.btnRow{display:flex;gap:8px}

button{
padding:8px 12px;
border:none;
border-radius:8px;
background:#0d6efd;
color:#fff;
font-size:13px
}

.box{background:#fff;margin:10px;padding:12px;border-radius:12px}

.routeGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.partyList{max-height:220px;overflow:auto;font-size:13px}

.grid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
gap:10px;
padding:10px
}

.card{background:#fff;padding:14px;border-radius:12px;font-size:14px}

.profile{
position:fixed;top:0;left:0;width:100%;height:100%;
background:#f2f2f2;overflow:auto;z-index:10
}

.profileCard{background:#fff;margin:10px;padding:16px;border-radius:14px}

.actionRow{display:flex;gap:10px;margin-top:10px}
.actionRow button{flex:1}
</style>
</head>

<body>

<div class="header">Aaradhya Today</div>

<div class="statusBar">

<div id="statusText" class="statusText">ðŸ”„ Loading data...</div>

<div class="btnRow">
<button onclick="reloadData()">ðŸ”„ Reload</button>
<button onclick="clearCache()">ðŸ§¹ Clear Cache</button>
</div>

</div>

<div id="routeBox" class="box"></div>
<div id="grid" class="grid"></div>
<div id="profile" class="profile" style="display:none"></div>

<script>

const CSV_LINK="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

function getCSVUrl(){
return CSV_LINK+"&nocache="+Date.now()
}

function updateStatus(msg){
statusText.innerHTML=msg
}

function reloadData(){
fetchData()
}

function clearCache(){

localStorage.clear()

if('caches' in window){
caches.keys().then(names=>{
for(let name of names) caches.delete(name)
})
}

location.reload()
}

function fetchData(){

updateStatus("ðŸ”„ Syncing latest data...")

fetch(getCSVUrl())
.then(r=>r.text())
.then(text=>{

localStorage.setItem("csv",text)

let time=new Date().toLocaleTimeString()

updateStatus("ðŸŸ¢ Live Data â€¢ "+time)

loadData(text)

})
.catch(()=>{

let data=localStorage.getItem("csv")

updateStatus("ðŸŸ  Offline Data")

loadData(data)

})
}

function parseCSV(text){
const rows=[];let row=[],value="",insideQuotes=false
for(let char of text){
if(char=='\"'){insideQuotes=!insideQuotes;continue}
if(char==\",\"&&!insideQuotes){row.push(value);value=\"\";continue}
if((char==\"\\n\"||char==\"\\r\")&&!insideQuotes){
if(value||row.length){row.push(value);rows.push(row)}
row=[];value=\"\";continue}
value+=char
}
return rows
}

function loadData(text){

let rows=parseCSV(text).slice(1).filter(r=>r[0])

customers=rows.map(r=>({
name:r[0],
area:r[1],
due:r[6],
phone:r[13],
lat:parseFloat(r[14]),
lng:parseFloat(r[15])
}))

render()
}

function render(){

grid.innerHTML=""

customers.forEach(c=>{

grid.innerHTML+=`
<div class="card">
<b>${c.name}</b><br>
${c.area}<br>
â‚¹${c.due}
</div>`

})
}

fetchData()

</script>
</body>
</html>