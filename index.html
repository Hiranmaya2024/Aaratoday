<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aaradhya Today</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0d6efd">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

<style>
body{font-family:Poppins;margin:0;background:#f4f6f9}
.header{background:#0d6efd;color:#fff;padding:14px;font-weight:600}
.statusBar{padding:6px 14px;font-size:13px;background:#fff}
.btnRow{padding:6px 14px;background:#fff;display:flex;gap:10px}
button{padding:8px 12px;border:none;border-radius:6px;background:#0d6efd;color:#fff}
.routeBox{background:#fff;margin:10px;padding:14px;border-radius:14px;display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid{padding:10px;display:grid;gap:12px}
.customer{background:#fff;padding:14px;border-radius:12px}
.profileWrapper{background:#f4f6f9;min-height:100vh}
.profileHeader{background:#0d6efd;color:#fff;padding:14px;display:flex;gap:10px}
.tour{background:#ff9800;width:100%;margin-top:10px}
input,select{width:100%;padding:10px;margin:6px 0}
</style>
</head>

<body>

<div id="mainScreen">

<div class="header">Aaradhya Today</div>

<div id="dataStatus" class="statusBar"></div>

<div class="btnRow">
<button onclick="forceRefresh()">üîÑ Refresh</button>
<button onclick="clearCache()">üßπ Clear Cache</button>
</div>

<div id="routeBox" class="routeBox"></div>
<div id="customerGrid" class="grid"></div>

</div>

<div id="profileScreen" style="display:none"></div>

<script>

function getCSVUrl(){
return "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv&nocache="+new Date().getTime()
}

const tourPlan={
Monday:["Juria"],Tuesday:["Ghess"],Wednesday:["Gaisilate"],
Thursday:["Dava"],Friday:["Padampur"],Saturday:["Paikmal","Mandosil"]
}

const today=new Date().toLocaleDateString('en-US',{weekday:'long'})
const todayAreas=tourPlan[today]||[]

let customers=[],todayRoute=[],selected={}
let visitedParties=JSON.parse(localStorage.getItem("visitedParties")||"[]")
let collections=JSON.parse(localStorage.getItem("collections")||"[]")

let userLat=0,userLng=0

navigator.geolocation.watchPosition(pos=>{
userLat=pos.coords.latitude
userLng=pos.coords.longitude
renderAll()
})

function updateStatus(msg){
document.getElementById("dataStatus").innerHTML=msg
}

function fetchData(){

updateStatus("üîÑ Syncing latest data...")

fetch(getCSVUrl())
.then(res=>res.text())
.then(text=>{

localStorage.setItem("customerCSV",text)

let time=new Date().toLocaleTimeString()
localStorage.setItem("lastSync",time)

updateStatus("üü¢ Live data ‚Ä¢ "+time)

loadData(text)

})
.catch(()=>{

let offlineData=localStorage.getItem("customerCSV")

if(offlineData){
updateStatus("üü† Offline data ‚Ä¢ "+localStorage.getItem("lastSync"))
loadData(offlineData)
}else{
updateStatus("‚ùå No data available")
}

})
}

function forceRefresh(){
fetchData()
}

function clearCache(){

localStorage.clear()

caches.keys().then(names=>{
for (let name of names) caches.delete(name)
})

alert("Cache cleared. Reloading...")
location.reload()
}

fetchData()

setInterval(fetchData,120000)

function parseCSV(text){
const rows=[];let row=[],value="",insideQuotes=false
for(let char of text){
if(char=='"'){insideQuotes=!insideQuotes;continue}
if(char==","&&!insideQuotes){row.push(value);value="";continue}
if((char=="\n"||char=="\r")&&!insideQuotes){
if(value||row.length){row.push(value);rows.push(row)}
row=[];value="";continue}
value+=char}
return rows
}

function loadData(text){

let rows=parseCSV(text).slice(1).filter(r=>r[0])

customers=rows.map(r=>({
name:r[0],area:r[1],due:r[6],
phone:r[13],
lat:parseFloat(r[14]),
lng:parseFloat(r[15]),
lastSale:r[17],
lastCollection:r[18],
route:r[19]
}))

todayRoute=customers.filter(c=>todayAreas.includes(c.area))

renderAll()
}

function getDistance(lat,lng){
if(!userLat||!lat) return 9999
const R=6371
const dLat=(lat-userLat)*Math.PI/180
const dLng=(lng-userLng)*Math.PI/180
const a=Math.sin(dLat/2)**2+
Math.cos(userLat*Math.PI/180)*Math.cos(lat*Math.PI/180)*
Math.sin(dLng/2)**2
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))
}

function renderAll(){

let remaining=todayRoute.filter(p=>!visitedParties.includes(p.name))
remaining.sort((a,b)=>getDistance(a.lat,a.lng)-getDistance(b.lat,b.lng))

let next=remaining[0]

let nextHTML="Tour Completed üéâ"

if(next){
let dist=getDistance(next.lat,next.lng).toFixed(2)
let time=(dist/25*60).toFixed(0)
nextHTML=`<b>Next:</b> ${next.name}<br>üìè ${dist} km ‚è± ${time} min`
}

routeBox.innerHTML=`
<div>${nextHTML}<br>
‚úî Parties: ${todayRoute.length}<br>
‚úÖ Visited: ${visitedParties.length}<br>
üí∞ Collection: ‚Çπ ${collections.reduce((s,c)=>s+Number(c.amount),0)}
</div>

<div>
${todayRoute.map(c=>`<div onclick="openProfile('${c.name}')">${c.name}</div>`).join("")}
</div>
`

customerGrid.innerHTML=""
customers.forEach(c=>{
customerGrid.innerHTML+=`
<div class="customer" onclick="openProfile('${c.name}')">
<b>${c.name}</b><br>${c.area} | ‚Çπ${c.due}
</div>`
})
}

function openProfile(name){

selected=customers.find(c=>c.name===name)

mainScreen.style.display="none"
profileScreen.style.display="block"

profileScreen.innerHTML=`
<div class="profileWrapper">
<div class="profileHeader">
<button onclick="goBack()">‚¨Ö Back</button>${selected.name}
</div>

<div class="profileCard">

<div>üìÖ ${selected.lastSale}</div>
<div>üí∞ ${selected.lastCollection}</div>
<div>üó∫ ${selected.route}</div>

<input id="amt" placeholder="Collection amount">

<button class="tour" onclick="saveCollection()">Save</button>
<button class="tour" onclick="visitDone()">Visit Done</button>

</div>
</div>`
}

function saveCollection(){
let amt=document.getElementById("amt").value
if(!amt)return alert("Enter amount")
collections.push({party:selected.name,amount:amt})
localStorage.setItem("collections",JSON.stringify(collections))
renderAll()
}

function visitDone(){
visitedParties.push(selected.name)
localStorage.setItem("visitedParties",JSON.stringify(visitedParties))
goBack()
}

function goBack(){
profileScreen.style.display="none"
mainScreen.style.display="block"
renderAll()
}

if('serviceWorker' in navigator){
navigator.serviceWorker.register('service-worker.js')
}

</script>
</body>
</html>