<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aaradhya Today</title>

<style>

:root{
--primary:#0d6efd;
--bg:#eef2f7;
--card:#ffffff;
--text:#1f2933;
--success:#198754;
--danger:#dc3545;
--warning:#ff9800;
--radius:18px;
}

body{
margin:0;
font-family:system-ui,-apple-system,Segoe UI,Roboto;
background:var(--bg);
color:var(--text);
}

.app{
max-width:1400px;
margin:auto;
}

/* HEADER */

.header{
position:sticky;
top:0;
background:linear-gradient(135deg,#0d6efd,#3b82f6);
color:#fff;
padding:16px;
font-size:20px;
font-weight:600;
box-shadow:0 4px 14px rgba(0,0,0,0.12);
z-index:10;
}

/* STATUS BAR */

.statusBar{
margin:14px;
padding:12px 16px;
border-radius:18px;
background:rgba(255,255,255,0.7);
backdrop-filter:blur(10px);
display:flex;
justify-content:space-between;
align-items:center;
flex-wrap:wrap;
gap:10px;
box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

/* ROUTE */

.routeGrid{
display:grid;
gap:16px;
margin:14px;
}

@media(min-width:768px){
.routeGrid{grid-template-columns:1fr 1fr;}
}

.partyList{
max-height:280px;
overflow:auto;
}

/* GRID */

.grid{
display:grid;
grid-template-columns:repeat(2,1fr);
gap:14px;
padding:14px;
}

@media(min-width:700px){
.grid{grid-template-columns:repeat(3,1fr);}
}

@media(min-width:1200px){
.grid{grid-template-columns:repeat(4,1fr);}
}

/* CARD */

.card{
background:var(--card);
padding:16px;
border-radius:18px;
box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.blocked{border-left:6px solid var(--danger);}
.active{border-left:6px solid var(--success);}

.badge{
padding:4px 10px;
border-radius:999px;
font-size:11px;
font-weight:600;
margin-left:6px;
color:#fff;
}

.badgeBlocked{background:var(--danger);}
.badgeActive{background:var(--success);}
.badgeFollow{background:var(--warning);}
.newTag{background:#7c3aed;}

/* PROFILE */

.profile{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:var(--bg);
overflow:auto;
padding:20px;
z-index:100;
}

.profileCard{
background:#fff;
border-radius:18px;
padding:20px;
max-width:720px;
margin:auto;
box-shadow:0 10px 30px rgba(0,0,0,0.12);
}

/* BUTTONS */

.iconBtn{
height:54px;
border:none;
border-radius:14px;
background:linear-gradient(135deg,#0d6efd,#3b82f6);
color:#fff;
font-size:22px;
display:flex;
align-items:center;
justify-content:center;
flex:1;
}

.actionRow{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:12px;
margin-top:18px;
}

input{
width:100%;
padding:12px;
margin-top:12px;
border-radius:12px;
border:1px solid #ddd;
font-size:15px;
}

</style>
</head>

<body>

<div class="app">

<div class="header">Aaradhya Today</div>

<div class="statusBar">
<div id="dataInfo">Loading...</div>
<div>
<button onclick="fetchData()">ğŸ”„</button>
<button onclick="clearCache()">ğŸ§¹</button>
</div>
</div>

<div id="routeBox"></div>
<div id="grid" class="grid"></div>

<div id="profile" class="profile" style="display:none"></div>

</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

const HQ_LAT=20.9964
const HQ_LNG=83.0526

let visited=JSON.parse(localStorage.getItem("visited")||"[]")
let collections=JSON.parse(localStorage.getItem("collections")||"[]")

function getDistance(lat,lng){
const R=6371
const dLat=(lat-HQ_LAT)*Math.PI/180
const dLng=(lng-HQ_LNG)*Math.PI/180
const a=Math.sin(dLat/2)**2+
Math.cos(HQ_LAT*Math.PI/180)*Math.cos(lat*Math.PI/180)*
Math.sin(dLng/2)**2
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))
}

function fetchData(){

dataInfo.innerHTML="ğŸ”„ Fetching..."

fetch(CSV+"&nocache="+Date.now())
.then(r=>r.text())
.then(text=>{
dataInfo.innerHTML="ğŸŸ¢ "+new Date().toLocaleTimeString()
loadData(text)
})
}

function parseCSV(text){
return text.split("\n").map(e=>e.split(","))
}

function loadData(text){

let rows=parseCSV(text).slice(1).filter(r=>r[0])

customers=rows.map(r=>({

name:r[0],
area:r[1],
status:(r[2]||"").toLowerCase(),
business:r[5],
due:parseFloat(r[6])||0,
phone:r[13],
lat:parseFloat(r[14]),
lng:parseFloat(r[15]),
lastSale:r[17],
lastCollection:r[18],
route:r[19]

}))

customers.sort((a,b)=>b.due-a.due)

render()
}

function render(){

let routeDistance=calcDistance()

routeBox.innerHTML=`

<div class="routeGrid">

<div>

<b>ğŸ§­ Route Summary</b><br><br>

âœ” Parties: ${customers.length}<br>
ğŸ“ ${routeDistance.toFixed(1)} km<br>
â± ${(routeDistance/25).toFixed(1)} hr<br>

<button class="iconBtn" onclick="startTour()">ğŸ§­</button>

</div>

<div class="partyList">

${customers.map(c=>`
<div onclick="openProfile('${c.name}')">
<b>${c.name}</b><br>
ğŸ“ ${getDistance(c.lat,c.lng).toFixed(1)} km
</div><br>`).join("")}

</div>

</div>
`

grid.innerHTML=""

customers.forEach(c=>{

let isBlocked=c.status.includes("blocked")

let statusClass=isBlocked?"blocked":"active"

let statusBadge=isBlocked
?'<span class="badge badgeBlocked">BLOCKED</span>'
:'<span class="badge badgeActive">ACTIVE</span>'

let followBadge=c.due==0
?'<span class="badge badgeFollow">FOLLOW-UP</span>'
:""

grid.innerHTML+=`

<div class="card ${statusClass}" onclick="openProfile('${c.name}')">

<b>${c.name}</b><br>
${c.area}<br>
â‚¹${c.due}<br>
ğŸ“ ${getDistance(c.lat,c.lng).toFixed(1)} km

${statusBadge}${followBadge}

</div>
`
})

}

function calcDistance(){
let total=0
customers.forEach(p=>total+=getDistance(p.lat,p.lng))
return total*2
}

function openProfile(name){

let c=customers.find(x=>x.name==name)

profile.style.display="block"

profile.innerHTML=`

<div class="profileCard">

<button class="iconBtn" style="max-width:60px" onclick="profile.style.display='none'">â¬…</button>

<h2>${c.name}</h2>

ğŸ“ <a href="tel:${c.phone}">${c.phone}</a><br>
Area: ${c.area}<br>
Total Business: ${c.business}<br>
Total Due: ${c.due}<br>

ğŸ“… ${c.lastSale}<br>
ğŸ’° ${c.lastCollection}<br>
ğŸ—º ${c.route}<br>

<input id="amt" placeholder="Enter collection">

<div class="actionRow">

<button class="iconBtn" onclick="saveCollection('${c.name}')">ğŸ’¾</button>
<button class="iconBtn" onclick="markVisited('${c.name}')">âœ…</button>
<button class="iconBtn" onclick="window.open('tel:${c.phone}')">ğŸ“</button>

<button class="iconBtn" onclick="window.open('https://wa.me/91${c.phone}')">ğŸ’¬</button>
<button class="iconBtn" onclick="window.open('https://maps.google.com?q=${c.lat},${c.lng}')">ğŸ“</button>

</div>

</div>
`
}

function saveCollection(name){
let amt=document.getElementById("amt").value
collections.push({party:name,amount:amt})
localStorage.setItem("collections",JSON.stringify(collections))
}

function markVisited(name){
if(!visited.includes(name)){
visited.push(name)
localStorage.setItem("visited",JSON.stringify(visited))
}
profile.style.display="none"
}

function startTour(){
let waypoints=customers.slice(0,9).map(c=>`${c.lat},${c.lng}`).join("/")
window.open(`https://www.google.com/maps/dir/${HQ_LAT},${HQ_LNG}/${waypoints}/${HQ_LAT},${HQ_LNG}`)
}

function clearCache(){
if(!confirm("Clear cache?"))return
localStorage.clear()
location.reload()
}

fetchData()

</script>

</body>
</html>
