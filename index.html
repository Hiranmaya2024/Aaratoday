<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aaradhya Today</title>

<style>

:root{
--primary:#0d6efd;
--bg:#eef2f7;
--card:#fff;
--success:#198754;
--danger:#dc3545;
--warning:#ff9800;
}

body{margin:0;font-family:system-ui;background:var(--bg);}
.app{max-width:1400px;margin:auto;}

.header{
position:sticky;top:0;
background:linear-gradient(135deg,#0d6efd,#3b82f6);
color:#fff;padding:16px;font-size:20px;font-weight:600;
}

.statusBar{
margin:14px;padding:12px 16px;border-radius:18px;
background:rgba(255,255,255,0.7);
display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;
}

/* ROUTE CARD */

.routeCard{
background:#fff;
margin:14px;
padding:18px;
border-radius:22px;
box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.routeGrid{
display:grid;
gap:18px;
}

@media(min-width:768px){
.routeGrid{
grid-template-columns:1.1fr 1fr;
}
}

.mapPreview{
width:100%;
height:180px;
border-radius:14px;
border:0;
margin-bottom:12px;
}

.routeTitle{font-size:20px;font-weight:700;margin-bottom:12px;}
.routeStats{font-size:16px;line-height:1.9;}

.startBtn{
margin-top:16px;
height:52px;
border:none;
border-radius:12px;
width:100%;
font-size:18px;
font-weight:600;
background:#ff9800;
color:#000;
box-shadow:0 4px 0 #b36a00;
}

.partyList{max-height:300px;overflow:auto;}

.partyListItem{margin-bottom:14px;cursor:pointer;}
.partyName{font-weight:600;font-size:16px;}
.partyDistance{color:#555;margin-left:26px;font-size:14px;}

/* GRID */

.grid{
display:grid;
grid-template-columns:repeat(2,1fr);
gap:14px;
padding:14px;
}

@media(min-width:700px){.grid{grid-template-columns:repeat(3,1fr);}}
@media(min-width:1200px){.grid{grid-template-columns:repeat(4,1fr);}}

.card{background:#fff;padding:14px;border-radius:16px;}

.blocked{border-left:6px solid var(--danger);}
.active{border-left:6px solid var(--success);}

.badge{
padding:4px 10px;border-radius:999px;font-size:11px;color:#fff;margin-left:6px;
}
.badgeBlocked{background:var(--danger);}
.badgeActive{background:var(--success);}
.badgeFollow{background:var(--warning);}

/* PROFILE */

.profile{
position:fixed;top:0;left:0;width:100%;height:100%;
background:var(--bg);overflow:auto;padding:20px;
}

.profileCard{
background:#fff;border-radius:18px;padding:20px;
max-width:720px;margin:auto;
}

.actionRow{
display:grid;
grid-template-columns:repeat(3,1fr);
gap:12px;margin-top:18px;
}

.iconBtn{
height:54px;border:none;border-radius:14px;
background:linear-gradient(135deg,#0d6efd,#3b82f6);
color:#fff;font-size:22px;width:100%;
}

input{
width:100%;
padding:12px;
margin-top:12px;
border-radius:12px;
border:1px solid #ddd;
}

</style>
</head>

<body>

<div class="app">

<div class="header">Aaradhya Today</div>

<div class="statusBar">
<div id="dataInfo"></div>

<div>
Day :
<select id="daySelect" onchange="changeDay(this.value)">
<option>Monday</option>
<option>Tuesday</option>
<option>Wednesday</option>
<option>Thursday</option>
<option>Friday</option>
<option>Saturday</option>
</select>

<button onclick="fetchData()">üîÑ</button>
</div>
</div>

<div id="routeBox"></div>
<div id="grid" class="grid"></div>
<div id="profile" class="profile" style="display:none"></div>

</div>

<script>

const CSV="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3bMMFf71-vdGNiWFnf7pD9XuAAUSA7J-g08ocyC2LNiVOTUHi56lB-7bKTKj0KK9nJGs9vU0THQ0E/pub?gid=1044390124&single=true&output=csv"

const HQ={lat:20.9964,lng:83.0526}

const tourPlan={
Monday:["Juria"],
Tuesday:["Ghess"],
Wednesday:["Gaisilate"],
Thursday:["Dava"],
Friday:["Padampur"],
Saturday:["Paikmal","Mandosil"]
}

let customers=[]
let visited=JSON.parse(localStorage.getItem("visited")||"[]")
let collections=JSON.parse(localStorage.getItem("collections")||"[]")

let selectedDay=new Date().toLocaleDateString('en-US',{weekday:'long'})
document.addEventListener("DOMContentLoaded",()=>daySelect.value=selectedDay)

function normalize(v){return (v||"").toLowerCase().trim()}
function changeDay(day){selectedDay=day;render()}

function getDistance(a,b){
const R=6371
const dLat=(b.lat-a.lat)*Math.PI/180
const dLng=(b.lng-a.lng)*Math.PI/180
const aa=Math.sin(dLat/2)**2+
Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*
Math.sin(dLng/2)**2
return R*2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa))
}

function getMapPreviewUrl(){
return `https://www.google.com/maps?q=${HQ.lat},${HQ.lng}&z=10&output=embed`
}

function parseCSV(text){
const rows=[];let row=[],value="",inside=false
for(let char of text){
if(char=='"'){inside=!inside;continue}
if(char==","&&!inside){row.push(value);value="";continue}
if((char=="\n"||char=="\r")&&!inside){
if(value||row.length){row.push(value);rows.push(row)}
row=[];value="";continue}
value+=char
}
return rows
}

function fetchData(){
dataInfo.innerHTML="üîÑ Fetching..."
fetch(CSV+"&nocache="+Date.now())
.then(r=>r.text())
.then(text=>{
dataInfo.innerHTML="üü¢ "+new Date().toLocaleTimeString()
loadData(text)
})
}

function loadData(text){
let rows=parseCSV(text)
rows.shift()
rows=rows.filter(r=>r[0])

customers=rows.map(r=>({
name:r[0],
area:r[1],
status:(r[2]||"").toLowerCase(),
business:r[5],
due:parseFloat(r[6])||0,
phone:r[13],
lat:parseFloat(r[14]),
lng:parseFloat(r[15]),
lastSale:r[17],
lastCollection:r[18],
route:r[19]
}))

customers.sort((a,b)=>b.due-a.due)
render()
}

function getTodayRoute(){
let areas=tourPlan[selectedDay]||[]
return customers.filter(c=>areas.some(a=>normalize(a)===normalize(c.area)))
}

function calcDistance(route){
let total=0,current=HQ
route.forEach(p=>{total+=getDistance(current,p);current=p})
total+=getDistance(current,HQ)
return total
}

function getTodayCollection(){
return collections.reduce((s,c)=>s+Number(c.amount||0),0)
}

function render(){

let todayRoute=getTodayRoute()
todayRoute.sort((a,b)=>getDistance(HQ,a)-getDistance(HQ,b))

let visitedCount=visited.filter(v=>todayRoute.some(p=>p.name===v)).length
let remaining=todayRoute.length-visitedCount
let distance=calcDistance(todayRoute)

routeBox.innerHTML=`

<div class="routeCard">

<div class="routeGrid">

<div>

<div class="routeTitle">
üìÖ Today‚Äôs Route ‚Äì ${selectedDay}
</div>

<iframe class="mapPreview" src="${getMapPreviewUrl()}" loading="lazy"></iframe>

<div class="routeStats">
‚úî Parties: ${todayRoute.length}<br>
üë£ Visited: ${visitedCount} / ${remaining}<br>
üí∞ Today: ‚Çπ${getTodayCollection()}<br>
‚úî Round-trip: ${distance.toFixed(1)} km<br>
‚úî Travel time: ${(distance/25).toFixed(1)} hrs
</div>

<button class="startBtn" onclick="startTour()">üß≠ Start Tour</button>

</div>

<div class="partyList">

${todayRoute.map((c,i)=>`
<div class="partyListItem" onclick="openProfile('${c.name}')">
<div class="partyName">${i+1}. ${c.name}</div>
<div class="partyDistance">üìç ${getDistance(HQ,c).toFixed(1)} km</div>
</div>
`).join("")}

</div>

</div>

</div>
`

grid.innerHTML=""
}

function startTour(){
let route=getTodayRoute()
let waypoints=route.slice(0,9).map(p=>`${p.lat},${p.lng}`).join("/")
window.open(`https://www.google.com/maps/dir/${HQ.lat},${HQ.lng}/${waypoints}/${HQ.lat},${HQ.lng}`)
}

fetchData()

</script>
</body>
</html>